/*
 * jQuery UI RGBA ColorPicker
 *
 * Copyright (c) 2013 jReply LLC http://jreply.com
 * Licensed under the terms of the MIT license - http://opensource.org/licenses/MIT
 *
 * RGBA color picker with 
 * 1. a simple point & click interface
 * 2. the ability to store up to 8 color values as named presets
 *
 * Sample usage:See the code in index.html
 *
 * Typically, in response to a user generated event; e.g. a button click;
 * do $('<div>').jreply_rgbapicker(options);
 * Options is the configuration object with the following attributes
 * 1. caption - the title for the RGBA color picker dialog
 * 2. rgba - the initial RGBA color value, e.g. 23,153,19,1
 * 3. callback - a callback function to handle the color assignment
 *
 * The callback function, if provided, gets the new RGBA value
 * as the string rgba(r,g,b,a)
 *
 * Typically you would use the callback to update a color display
 * somewhere in your application
 *
 * The default color picker image, rainbow.png, may be replaced to 
 * provide a bigger base of predefined colors that the user may
 * choose from.
 
 *  The sprintf routine is taken from http://phpjs.org/functions/sprintf/.
 * Original by Ash Searle (http://hexmen.com/blog/)
 * Improved by 
  
 * Kevin van Zonneveld http://kevin.vanzonneveld.net
 * Brett Zamir (http://brett-zamir.me)
 * Michael White (http://getsprink.com)
 * Allidylls,Dj
*/

function jrp_sprintf(){var s=/%%|%(\d+\$)?([-+\'#0 ]*)(\*\d+\$|\*|\d+)?(\.(\*\d+\$|\*|\d+))?([scboxXuideEfFgG])/g,n=arguments,u=0,o=n[u++],r=function(n,t,i,r){i||(i=" ");var u=n.length>=t?"":Array(1+t-n.length>>>0).join(i);return r?n+u:u+n},i=function(n,t,i,u,f,e){var o=u-n.length;return o>0&&(n=i||!f?r(n,u,e,i):n.slice(0,t.length)+r("",o,"0",!0)+n.slice(t.length)),n},t=function(n,t,u,f,e,o,s){var h=n>>>0;return u=u&&h&&({"2":"0b","8":"0","16":"0x"})[t]||"",n=u+r(h.toString(t),o||0,"0",!1),i(n,u,f,e,s)},f=function(n,t,r,u,f,e){return u!=null&&(n=n.slice(0,u)),i(n,"",t,r,f,e)},e=function(e,o,s,h,c,l,a){var w,k,nt,it,v,d;if(e=="%%")return"%";var y=!1,g="",p=!1,b=!1,tt=" ",rt=s.length;for(d=0;s&&d<rt;d++)switch(s.charAt(d)){case" ":g=" ";break;case"+":g="+";break;case"-":y=!0;break;case"'":tt=s.charAt(d+1);break;case"0":p=!0;break;case"#":b=!0}h=h?h=="*"?+n[u++]:h.charAt(0)=="*"?+n[h.slice(1,-1)]:+h:0,h<0&&(h=-h,y=!0);if(!isFinite(h))throw new Error("sprintf: (minimum-)width must be finite");l=l?l=="*"?+n[u++]:l.charAt(0)=="*"?+n[l.slice(1,-1)]:+l:"fFeE".indexOf(a)>-1?6:a=="d"?0:undefined,v=o?n[o.slice(0,-1)]:n[u++];switch(a){case"s":return f(String(v),y,h,l,p,tt);case"c":return f(String.fromCharCode(+v),y,h,l,p);case"b":return t(v,2,b,y,h,l,p);case"o":return t(v,8,b,y,h,l,p);case"x":return t(v,16,b,y,h,l,p);case"X":return t(v,16,b,y,h,l,p).toUpperCase();case"u":return t(v,10,b,y,h,l,p);case"i":case"d":return w=+v||0,w=Math.round(w-w%1),k=w<0?"-":g,v=k+r(String(Math.abs(w)),l,"0",!1),i(v,k,y,h,p);case"e":case"E":case"f":case"F":case"g":case"G":return w=+v,k=w<0?"-":g,nt=(["toExponential","toFixed","toPrecision"])["efg".indexOf(a.toLowerCase())],it=(["toString","toUpperCase"])["eEfFgG".indexOf(a)%2],v=k+Math.abs(w)[nt](l),i(v,k,y,h,p)[it]();default:return e}};return o.replace(s,e)}function jrp_findPos(n){var i=0,t=0;if(n.offsetParent){do i+=n.offsetLeft,t+=n.offsetTop;while(n=n.offsetParent);return{x:i,y:t}}return undefined}function jrp_Markup(){var n=["<div id='jrp_ColorPicker' style='display:none;font-size:0.8em'>","<div style='clear:both'>","<div class='jrp_democolordiv jrp_topfloat'>","<div id='jrp_cpsample' class='jrp_cpsample' title='Color Preview. Chequered Background = Translucent color'>","&nbsp;</div></div>","<input id='jrp_inpRGBDirect' class='jrp_cpsample jrp_topfloat' style='text-transform:uppercase;margin-top:4px;' title='Edit RGB color' placeholder='RGB Color' maxlength='6'/>","</div>","<div id='jrp_colorpre_outer' class='jrp_divcolorpre'>","<div id='jrp_colorpre_inner' style='clear:left'>","<div class='jrp_preset' id='jrp_0'>&nbsp;</div>","<div class='jrp_preset' id='jrp_1'>&nbsp;</div>","<div class='jrp_preset' id='jrp_2'>&nbsp;</div>","<div class='jrp_preset' id='jrp_3'>&nbsp;</div>","<div class='jrp_preset' id='jrp_4'>&nbsp;</div>","<div class='jrp_preset' id='jrp_5'>&nbsp;</div>","<div class='jrp_preset' id='jrp_6'>&nbsp;</div>","<div class='jrp_preset' id='jrp_7' style='clear:right'>&nbsp;</div>","</div>","<input id='jrp_inpColorPre' class='jrp_direct' title='Enter a name to save the current color as a preset' placeholder='Preset Name'/>","</div>","<canvas id='jrp_canvas' width='470' height='328' style='cursor:pointer;margin:6px' title='Click on a color block or the black/white background to select that color'></canvas>","<div  id='jrp_divAlpha' style='margin-top:5px' title='Color Opacity'></div>","<input id='jrp_inpRGBNow' type='hidden'/></div>"];return n.join("\n")}function jrp_config(n){var i=new Image,o=$("#jrp_canvas").get(0).getContext("2d"),t,e,r,f,u;i.onload=function(){o.drawImage(i,0,0),i=null},i.src="rainbow.png",$("#jrp_canvas").click(function(n){jrp_ccpClick(n)}),$("#jrp_inpRGBDirect").keyup(function(){jrp_updateRGBDirect()}),$("#jrp_divAlpha").slider({orientation:"horizontal",min:0,max:100,slide:jrp_refreshSwatch,change:jrp_refreshSwatch}),t=n.rgba.split(","),$("#jrp_inpRGBNow").data("rgba",JSON.stringify(t)),$("#jrp_divAlpha").slider("value",parseFloat(t[3])*100),e=jrp_sprintf("%02x",t[0])+jrp_sprintf("%02x",t[1])+jrp_sprintf("%02x",t[2]),$("#jrp_inpRGBDirect").val(e),jrp_updateDemoColor(t.join(",")),r="object"==typeof window.localStorage,f=r?"block":"none",$("#jrp_colorpre_outer").css("display",f),r&&($(".jrp_preset").click(function(n){jrp_assignPreset(n.target)}),u=localStorage.getItem("jrp_presets"),jrp_pre=null==u?[]:jQuery.parseJSON(u),jrp_refreshColorPresets())}function jrp_ccpClick(n){var i=jrp_findPos($("#jrp_canvas").get(0)),r;if(undefined==i)return;var o=n.pageX-i.x,f=n.pageY-i.y,e=$("#jrp_canvas").get(0).getContext("2d"),t=e.getImageData(o,f,1,1).data,u=jrp_sprintf("%02x",t[0])+jrp_sprintf("%02x",t[1])+jrp_sprintf("%02x",t[2]);$("#jrp_inpRGBDirect").val(u),r=$("#jrp_divAlpha").slider("value")/100,t=[t[0],t[1],t[2],r],jrp_updateDemoColor(t.join(",")),t=JSON.stringify(t),$("#jrp_inpRGBNow").data("rgba",t)}function jrp_refreshSwatch(){p=$("#jrp_inpRGBNow").data("rgba"),p=jQuery.parseJSON(p),p[3]=$("#jrp_divAlpha").slider("value")/100,jrp_updateDemoColor(p.join(",")),p=JSON.stringify(p),$("#jrp_inpRGBNow").data("rgba",p)}function jrp_updateRGBDirect(){var r=$("#jrp_inpRGBDirect").val(),u=/[0-9a-fA-F]{6}/g,n,t,i;if(u.test(r)){for(n=r.match(/.{1,2}/g),t=0;t<3;t++)n[t]=parseInt("0x"+n[t]);i=$("#jrp_divAlpha").slider("value")/100,n=[n[0],n[1],n[2],i],jrp_updateDemoColor(n.join(",")),n=JSON.stringify(n),$("#jrp_inpRGBNow").data("rgba",n)}}function jrp_updateDemoColor(n){n="rgba("+n+")",$("#jrp_cpsample").css("backgroundColor",n)}function jrp_assignPreset(n){var r=parseInt($(n).attr("id").jrp_reverse()),t,i;if(r>=jrp_pre.length)return;clr=jrp_pre[r],$("#jrp_inpColorPre").val(clr.n),t=clr.c,$("#jrp_inpRGBNow").data("rgba",JSON.stringify(t)),$("#jrp_divAlpha").slider("value",parseFloat(t[3])*100),i=jrp_sprintf("%02x",t[0])+jrp_sprintf("%02x",t[1])+jrp_sprintf("%02x",t[2]),$("#jrp_inpRGBDirect").val(i),jrp_updateDemoColor(t.join(","))}function jrp_refreshColorPresets(){var r,n,t,i;for($(".jrp_preset").css("backgroundColor","").attr("title","No preset assigned"),r=jrp_pre.length,n=0;n<r;n++)t=jrp_pre[n],i="rgba({cc})".jrp_format({cc:t.c}),$("#jrp_"+n).attr("title",t.n).css("backgroundColor",i)}function jrp_addToColorsPreset(n,t){var i,r,u;if("undefined"==typeof window.localStorage)return;for(i=jrp_pre.length,r=0;r<i;r++)i=t==jrp_pre[r].n?r:i;u={n:t,c:n},i<jrp_pre.length?jrp_pre[i]=u:(8==i&&jrp_pre.shift(),jrp_pre.push(u)),localStorage.setItem("jrp_presets",JSON.stringify(jrp_pre))}function jreply_rgba_apply(n){var t,i,r;null!=n&&(t=$("#jrp_inpRGBNow").data("rgba"),t=jQuery.parseJSON(t),i=$("#jrp_inpColorPre").val(),r=t.join(","),0<i.length&&jrp_addToColorsPreset(t,i),t="rgba("+t.toString()+")",n(t),$("#jrp_ColorPicker").dialog("destroy"))}function jrp_cleanup(){deletejrp_pre}String.prototype.jrp_reverse=function(){return this.split("").reverse().join("")},String.prototype.jrp_format=function(n){var i=this,t;for(t in n)i=i.replace("{"+t+"}",n[t]);return i},(function(n){n.widget("ui.jreply_rgbapicker",{options:{caption:"RGBA Color Picker",rgba:"23,153,19,1",callback:null},_create:function(){var u=this,t=u.options,r=jrp_Markup(),i={Apply:function(){jreply_rgba_apply(t.callback)},Cancel:function(){n("#jrp_ColorPicker").dialog("destroy")}};n(r).dialog({height:"auto",width:"500",dialogClass:"jreply_noclose",buttons:i,create:function(){jrp_config(t)},beforeClose:jrp_cleanup,title:t.caption})}})})(jQuery)